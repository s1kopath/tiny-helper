name: NAGADHAT STAGING DEPLOYMENT (HTTPS)

on:
  push:
    branches:
      - development-branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Deploy via SSH and Git Pull (HTTPS)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NAGADHAT_STG_HOST }}
          username: ${{ secrets.NAGADHAT_STG_USER }}
          port: ${{ secrets.NAGADHAT_STG_PORT }}
          key: ${{ secrets.NAGADHAT_STG_SSH_KEY }}
          script: |
            set -e  # Exit on any error
            
            # Configuration
            APP_DIR="/var/www/html"
            BRANCH="development-branch"
            
            echo "ğŸ“¦ Starting deployment to staging..."
            echo "================================================"
            
            cd $APP_DIR
            
            # Check for uncommitted changes
            if [[ -n $(git status -s) ]]; then
              echo "âš ï¸  Warning: Uncommitted changes detected. Stashing..."
              git stash save "Auto-stash before deployment $(date +%Y%m%d-%H%M%S)"
            fi
            
            # Fetch and pull latest changes using HTTPS
            echo "ğŸ”„ Fetching latest changes from $BRANCH..."
            git fetch origin $BRANCH
            
            echo "â¬‡ï¸  Pulling changes..."
            git pull origin $BRANCH
            
            # Check if .env exists
            if [ ! -f .env ]; then
              echo "ğŸ“ Creating .env file from example..."
              cp .env.example .env
              php artisan key:generate --force
            fi
            
            # Install/Update Composer dependencies
            echo "ğŸ“š Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
            
            # Clear old caches
            echo "ğŸ§¹ Clearing old caches..."
            php artisan optimize:clear
            
            # Laravel optimizations
            echo "âš¡ Optimizing Laravel application..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Set proper permissions
            echo "ğŸ” Setting directory permissions..."
            chmod -R 755 storage bootstrap/cache
            
            # Optional: Run database migrations
            # Uncomment the lines below when ready to run migrations
            # echo "ğŸ—„ï¸  Running database migrations..."
            # php artisan migrate --force
            
            # Optional: Seed database
            # echo "ğŸŒ± Seeding database..."
            # php artisan db:seed --force
            
            # Reload PHP-FPM (adjust PHP version as needed)
            echo "ğŸ”„ Reloading PHP-FPM..."
            sudo systemctl reload php8.2-fpm 2>/dev/null || sudo systemctl reload php8.1-fpm 2>/dev/null || sudo systemctl reload php-fpm 2>/dev/null || true
            
            # Display deployment info
            echo "================================================"
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“Œ Current commit: $(git log -1 --pretty=format:'%h - %s (%an, %ar)')"
            echo "ğŸ“… Deployed at: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "================================================"
      
      - name: ğŸ“¬ Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment to staging completed successfully"
          else
            echo "âŒ Deployment to staging failed"
            exit 1
          fi
